name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================
  # STAGE 1: Test & Build (parallel)
  # ============================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.CI_POSTGRES_PASSWORD || 'testpassword123' }}
          POSTGRES_DB: test_congresstrack
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements/*.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/development.txt

      - name: Run linting
        run: |
          ruff check .
          black --check .

      - name: Run type checking
        run: mypy .

      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.CI_POSTGRES_PASSWORD || 'testpassword123' }}@localhost:5432/test_congresstrack
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SETTINGS_MODULE: config.settings.test
          SECRET_KEY: test-secret-key-for-ci
        run: pytest -v --tb=short

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run typecheck

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.congresstrack.org/api/v1

  # ============================================
  # STAGE 2: Deploy Backend (Railway)
  # ============================================
  deploy-backend:
    name: Deploy Backend
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      backend_url: ${{ steps.deploy.outputs.backend_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Django API
        id: deploy
        run: |
          cd backend
          railway up --service congresstrack-api --detach

          # Get the deployment URL
          BACKEND_URL=$(railway domain --service congresstrack-api)
          echo "backend_url=https://${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "Backend URL: https://${BACKEND_URL}"

      - name: Run database migrations
        run: |
          cd backend
          railway run --service congresstrack-api python manage.py migrate --noinput

      - name: Deploy Celery Worker
        run: |
          cd backend
          railway up --service congresstrack-celery --detach

      - name: Deploy Celery Beat
        run: |
          cd backend
          railway up --service congresstrack-celery-beat --detach

      - name: Health check
        id: health_check
        run: |
          BACKEND_URL="${{ steps.deploy.outputs.backend_url }}"
          echo "Waiting for backend to be healthy..."

          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/api/health/" || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Backend is healthy!"
              exit 0
            fi

            echo "Health check returned $HTTP_STATUS, waiting 10s..."
            sleep 10
          done

          echo "Backend health check failed after $MAX_ATTEMPTS attempts"
          exit 1

  # ============================================
  # STAGE 3: Deploy Frontend (Vercel)
  # ============================================
  deploy-frontend:
    name: Deploy Frontend
    needs: [deploy-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: |
          cd frontend
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build for Production
        run: |
          cd frontend
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          NEXT_PUBLIC_API_URL: ${{ needs.deploy-backend.outputs.backend_url }}/api/v1

      - name: Deploy to Vercel
        run: |
          cd frontend
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend API | ${{ needs.deploy-backend.outputs.backend_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | https://congresstrack.vercel.app |" >> $GITHUB_STEP_SUMMARY
